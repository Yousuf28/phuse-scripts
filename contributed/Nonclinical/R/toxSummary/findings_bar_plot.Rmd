---
title: "Findings in Bar Plot"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


### Import Library

```{r library, echo=TRUE, message=FALSE, warning=FALSE}
library(tidyverse)
library(ggstance)
library(ggrepel)
library(RColorBrewer)
library(patchwork)
library(ggh4x)
library(plotly)
#library(forcats)
```

### Create plotData dataframe for Safety Margin plot

```{r plotData dataframe}
Study <- rep(x = c("Rat-1-month", "Dog-1-month", "Dog-3-month", "Monkey-1-month"), times = 1, each = 3)
Dose <- c(1,33,100,1,3,10, 6, 30,78,5,50,90)
NOAEL <- c(TRUE, FALSE, FALSE, FALSE, TRUE, FALSE, FALSE,TRUE,FALSE,FALSE,TRUE,FALSE)
SM <- c(9.68, 319.35, 967.74, 33.33, 100.00, 333.333,200, 1000, 2600, 96,967.74,1741)
Dose_findings <- c("liver Necrosis [PR]", "liver Necrosis [PR]", "Mortality [NR]", "Emesis [Rev]",  "Emesis [Rev]", "Convulsion [NR]","Emesis [Rev]", "Carcinogenecity[NR]", "Emesis [Rev]",  "Necrosis[Rev]", "Necrosis[Rev]", "Carcinogenecity[NR]")

Severity_level <- c('Absent', 'Present', 'Minimal', 'Mild','Moderate','Marked', 'Severe')

Severity <- factor(c('Absent', 'Minimal', 'Mild','Moderate','Marked', 'Severe', 'Present',  'Minimal', 'Mild','Moderate','Marked', 'Severe'), levels = Severity_level)
Value <- c(rep(1, 12))
Value_order <- c(rep(c(1,2,3), 4))


plotData <- data.frame(Study, Dose, NOAEL, Dose_findings,Severity, SM, Value, Value_order)
print(plotData)
```

### Save species and duration (months) in separate variable

```{r make species a variable from study variable}
plotData <- separate(plotData, Study, into = c("Species","Months"), sep = "-", remove = FALSE,extra = 'merge' )
```

### Convert species as factor

```{r}
plotData$Species <- as.factor(plotData$Species)
```


### geom_point square overlap if big, and does not cover text if small

```{r geom_text with geom_point  ,  fig.width=16, fig.height=12}
# ggplot(df, aes(xmin = x - w / 2, xmax = x + w / 2, ymin = y, ymax = y + 1)) +
#   geom_rect(aes(fill = z), colour = "grey50")

p <- ggplot(plotData )+ 
  # geom_rect(aes(xmin = log10(SM)-50, xmax  = log10(SM)+50, ymin = Value-0.5, ymax = Value+0.5), fill = 'grey')+
  
  geom_point(aes(x = SM, y= Value),
             shape = 22,
             size =30, 
             fill = "grey")+

    geom_text(aes(x= SM, y= Value, label = paste(Dose, " mg/kg/day")),
               color = ifelse(plotData$NOAEL == TRUE, "#239B56", "black"),
               fontface = "bold")+
               #position = ggstance::position_dodge2v(height = 1, preserve = "total",padding=2))+
  
    scale_x_log10(limits = c(min(plotData$SM/2), max(plotData$SM*2)),sec.axis = dup_axis())+
  ylim(c(0.5, 4))+
    facet_nested( Species+ Months ~ .)+
  
    labs(x = "Safety Margin", title = "Summary of Toxicology Studies")+
    theme_bw(base_size=12)+
    theme(axis.title.y = element_blank(),
          # axis.ticks.y= element_blank(),
          # axis.text.y = element_blank(),
          # panel.grid.major = element_blank(),
          # panel.grid.minor = element_blank(),
          # plot.title = element_text(hjust = 0.5),
          # strip.text.y = element_text(size=11, color="black", face="plain"),
          strip.background = element_rect( fill = "white"))
#ggplotly(p)
p

```
 
 ### geom_tile does not match when window changes
 ### also for this fill to ifelse plotly does not work
  
```{r geom_tile fill conditional color}
p <- ggplot(plotData , aes (x = SM, y = Value_order))+
  geom_tile(fill = ifelse(plotData$NOAEL == TRUE, "#239B56", "black"),
            color = "transparent",
            width = 0.4,
            height = 0.6)+
  
  geom_text(aes(label = paste(Dose, " mg/kg/day")),
            color = "white",
            fontface = "bold")+
  
  
    scale_x_log10(limits = c(min(plotData$SM/2), max(plotData$SM*2)),sec.axis = dup_axis())+
  ylim(c(0.5, 4))+
    facet_nested( Species+ Months ~ .)+
  
    labs(x = "Safety Margin", title = "Summary of Toxicology Studies")+
    theme_bw(base_size=12)+
    theme(axis.title.y = element_blank(),
          # axis.ticks.y= element_blank(),
          # axis.text.y = element_blank(),
          # panel.grid.major = element_blank(),
          # panel.grid.minor = element_blank(),
          # plot.title = element_text(hjust = 0.5),
          # strip.text.y = element_text(size=11, color="black", face="plain"),
          strip.background = element_rect( fill = "white"))
p
#ggplotly(p)
```
  
plotly does not work in this case
 
```{r}
p <- ggplot(plotData )+
  geom_tile(aes (x = SM, y = Value_order),
            color = "transparent",
            width = 0.4,
            height = 0.6)+
  
  geom_text(aes(x = SM, y = Value_order, label = paste(Dose, " mg/kg/day")),
            color = "white",
            fontface = "bold")+
  
  
    scale_x_log10(limits = c(min(plotData$SM/2), max(plotData$SM*2)),sec.axis = dup_axis())+
  ylim(c(0.5, 4))+
    facet_nested( Species+ Months ~ .)+
  
    labs(x = "Safety Margin", title = "Summary of Toxicology Studies")+
    theme_bw(base_size=12)+
    theme(axis.title.y = element_blank(),
          # axis.ticks.y= element_blank(),
          # axis.text.y = element_blank(),
          # panel.grid.major = element_blank(),
          # panel.grid.minor = element_blank(),
          # plot.title = element_text(hjust = 0.5),
          # strip.text.y = element_text(size=11, color="black", face="plain"),
          strip.background = element_rect( fill = "white"))
#ggplotly(p)
p
```
  
  

# geom_react __ rectangular does not change with text when windows changes

```{r geom_rect with geom_text}
p <- ggplot(plotData )+ 
  
  geom_rect(aes(xmin = SM-210, xmax  =SM+210, ymin = Value_order -0.30, ymax = Value_order +0.30 ), fill = ifelse(plotData$NOAEL == TRUE, "#239B56", "black"))+
  

    geom_text(aes(x= SM, y= Value_order, label = paste(Dose, " mg/kg/day")),
               color = "white",
               fontface = "bold")+
               #position = ggstance::position_dodge2v(height = 1, preserve = "total",padding=2))+
  
  #scale_x_log10(limits = c(min(plotData$SM/2), max(plotData$SM*2))+
  ylim(c(0.5, 4))+
  
    facet_nested( Species+ Months ~ .)+
  
    labs(x = "Safety Margin", title = "Summary of Toxicology Studies")+
    theme_bw(base_size=12)+
    theme(axis.title.y = element_blank(),
          # axis.ticks.y= element_blank(),
          # axis.text.y = element_blank(),
          # panel.grid.major = element_blank(),
          # panel.grid.minor = element_blank(),
          # plot.title = element_text(hjust = 0.5),
          # strip.text.y = element_text(size=11, color="black", face="plain"),
          strip.background = element_rect( fill = "white"))
#ggplotly(p)
p
```


```{r geom_label}
p <- ggplot(plotData )+
    geom_label(aes(x = SM, y = Value, label = paste(Dose, " mg/kg/day")),
               color = 'white',
               fill = ifelse(plotData$NOAEL == TRUE, "#239B56", "black"),
               label.padding = unit(0.5, "lines"),
               fontface = "bold",
               position = ggstance::position_dodge2v(height = 1, preserve = "total",padding=2))+
  
    scale_x_log10(limits = c(min(plotData$SM/2), max(plotData$SM*2)),sec.axis = dup_axis())+
    facet_nested( Species+ Months ~ .)+
  
    labs(x = "Safety Margin", title = "Summary of Toxicology Studies")+
    theme_bw(base_size=12)+
    theme(axis.title.y = element_blank(),
          # axis.ticks.y= element_blank(),
          # axis.text.y = element_blank(),
          # panel.grid.major = element_blank(),
          # panel.grid.minor = element_blank(),
          # plot.title = element_text(hjust = 0.5),
          # strip.text.y = element_text(size=11, color="black", face="plain"),
          strip.background = element_rect( fill = "white"))
p
```


```{r geom_label with sm }
p <- ggplot(plotData )+
    geom_label(aes(x = SM, y = Value, label = paste("D:", Dose, "/", "SM:", round(SM , 1))),
               color = 'white',
               fill = ifelse(plotData$NOAEL == TRUE, "#239B56", "black"),
               label.padding = unit(0.5, "lines"),
               fontface = "bold",
               position = ggstance::position_dodge2v(height = 1, preserve = "total",padding=2))+
  
    scale_x_log10(limits = c(min(plotData$SM/2), max(plotData$SM*2)),sec.axis = dup_axis())+
    facet_nested( Species+ Months ~ .)+
  
    labs(x = "Safety Margin", title = "Summary of Toxicology Studies")+
    theme_bw(base_size=12)+
    theme(axis.title.y = element_blank(),
          # axis.ticks.y= element_blank(),
          # axis.text.y = element_blank(),
          # panel.grid.major = element_blank(),
          # panel.grid.minor = element_blank(),
          # plot.title = element_text(hjust = 0.5),
          # strip.text.y = element_text(size=11, color="black", face="plain"),
          strip.background = element_rect( fill = "white"))
p
```


### ggplotly does work with geom_text

```{r plotly with geom_text in safety margin plot}

p <- ggplot(plotData )+
    geom_text(aes(x = SM, y = Value, label = paste(Dose, " mg/kg/day")),
               color = ifelse(plotData$NOAEL == TRUE, "#239B56", "black"),
              size = 6,
            
               #fill = ifelse(plotData$NOAEL == TRUE, "#239B56", "black"),
               #label.padding = unit(0.5, "lines"),
               fontface = "bold",
               position = ggstance::position_dodge2v(height = 1, preserve = "total",padding=2))+
  
    scale_x_log10(limits = c(min(plotData$SM/2), max(plotData$SM*2)),sec.axis = dup_axis())+
    facet_nested( Species+ Months ~ .)+
  
    labs(x = "Safety Margin", title = "Summary of Toxicology Studies")+
    theme_bw(base_size=12)+
    theme(axis.title.y = element_blank(),
          # axis.ticks.y= element_blank(),
          # axis.text.y = element_blank(),
          # panel.grid.major = element_blank(),
          # panel.grid.minor = element_blank(),
          # plot.title = element_text(hjust = 0.5),
          # strip.text.y = element_text(size=11, color="black", face="plain"),
          strip.background = element_rect( fill = "white"))
#ggplotly(p)
ggplotly(p,tooltip = 'x')

```

### ggplotly with findings plot

```{r plotly with findings plot}
q <- ggplot(findings_data_long)+
    geom_col(aes(x= Findings, y = Value, fill = Severity, group = Dose),
             position = position_stack(reverse = TRUE),
             color = 'transparent')+
    geom_text(aes(x = Findings, y = Value, label = Dose, group = Dose),
              size = 4,
              color = 'white',
              fontface = 'bold',
              position = position_stack(vjust = 0.5, reverse = TRUE))+
    scale_y_discrete(position = 'right')+
    scale_fill_manual(values = color_manual)+
    facet_grid(Study ~ ., scales = 'free')+

    theme_bw(base_size=12)+
    theme(axis.title.y = element_blank(),
           strip.text.y = element_blank(),
           axis.ticks.y = element_blank(),
           axis.text.y = element_blank(),
           axis.title.x = element_blank(),
           axis.text.x = element_text(angle = 90),
         plot.title = element_text(hjust = 0.5),
         panel.grid.major.y = element_blank(),
         panel.grid.minor.y = element_blank(),
         panel.grid.major.x = element_line(),
         panel.grid.minor.x = element_blank(),
         legend.justification = "top")+
    labs(title = 'Findings' )+
    guides(fill = guide_legend(override.aes = aes(label = "")))
#q
ggplotly(q)

```

### ggplotly does not work in patchwork framework

```{r plotly with both plot in patchwork format}
p <- ggplot(plotData )+
    geom_text(aes(x = SM, y = Value, label = paste(Dose, " mg/kg/day")),
               color = ifelse(plotData$NOAEL == TRUE, "#239B56", "black"),
               size = 6,
               #label.padding = unit(0.5, "lines"),
               fontface = "bold",
               position = ggstance::position_dodge2v(height = 1, preserve = "total",padding=2))+
  
    scale_x_log10(limits = c(min(plotData$SM/2), max(plotData$SM*2)),sec.axis = dup_axis())+
    facet_nested( Species+ Months ~ .)+
  
    labs(x = "Safety Margin", title = "Summary of Toxicology Studies")+
    theme_bw(base_size=12)+
    theme(axis.title.y = element_blank(),
          axis.ticks.y= element_blank(),
          axis.text.y = element_blank(),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          plot.title = element_text(hjust = 0.5),
          strip.text.y = element_text(size=11, color="black", face="plain"),
          strip.background = element_rect( fill = "white"))

q <- ggplot(findings_data_long)+
    geom_col(aes(x= Findings, y = Value, fill = Severity, group = Dose),
             position = position_stack(reverse = TRUE),
             color = 'transparent')+
    geom_text(aes(x = Findings, y = Value, label = Dose, group = Dose),
              size = 4,
              color = 'white',
              fontface = 'bold',
              position = position_stack(vjust = 0.5, reverse = TRUE))+
    scale_y_discrete(position = 'right')+
    scale_fill_manual(values = color_manual)+
    facet_grid(Study ~ ., scales = 'free')+

    theme_bw(base_size=12)+
    theme(axis.title.y = element_blank(),
           strip.text.y = element_blank(),
           axis.ticks.y = element_blank(),
           axis.text.y = element_blank(),
           axis.title.x = element_blank(),
           axis.text.x = element_text(angle = 90),
         plot.title = element_text(hjust = 0.5),
         panel.grid.major.y = element_blank(),
         panel.grid.minor.y = element_blank(),
         panel.grid.major.x = element_line(),
         panel.grid.minor.x = element_blank(),
         legend.justification = "top")+
    labs(title = 'Findings' )+
    guides(fill = guide_legend(override.aes = aes(label = "")))

# p <- ggplotly(p)
# q <- ggplotly(q)
# p + q + plot_layout(ncol=2,widths=c(3,1))

ggplotly(p+q+plot_layout(ncol = 3, widths = c(3,1)))

```

```{r}
library(gridExtra)
```

### subplot with gridextra package

```{r}
p <- ggplot(plotData )+
    geom_text(aes(x = SM, y = Value, label = paste(Dose, " mg/kg/day")),
               color = ifelse(plotData$NOAEL == TRUE, "#239B56", "black"),
               size = 6,
               #label.padding = unit(0.5, "lines"),
               fontface = "bold",
               position = ggstance::position_dodge2v(height = 1, preserve = "total",padding=2))+
  
    scale_x_log10(limits = c(min(plotData$SM/2), max(plotData$SM*2)),sec.axis = dup_axis())+
    facet_nested( Species+ Months ~ .)+
  
    labs(x = "Safety Margin", title = "Summary of Toxicology Studies")+
    theme_bw(base_size=12)+
    theme(axis.title.y = element_blank(),
          axis.ticks.y= element_blank(),
          axis.text.y = element_blank(),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          plot.title = element_text(hjust = 0.5),
          strip.text.y = element_text(size=11, color="black", face="plain"),
          strip.background = element_rect( fill = "white"))

q <- ggplot(findings_data_long)+
    geom_col(aes(x= Findings, y = Value, fill = Severity, group = Dose),
             position = position_stack(reverse = TRUE),
             color = 'transparent')+
    geom_text(aes(x = Findings, y = Value, label = Dose, group = Dose),
              size = 4,
              color = 'white',
              fontface = 'bold',
              position = position_stack(vjust = 0.5, reverse = TRUE))+
    scale_y_discrete(position = 'right')+
    scale_fill_manual(values = color_manual)+
    facet_grid(Study ~ ., scales = 'free')+

    theme_bw(base_size=12)+
    theme(axis.title.y = element_blank(),
           strip.text.y = element_blank(),
           axis.ticks.y = element_blank(),
           axis.text.y = element_blank(),
           axis.title.x = element_blank(),
           axis.text.x = element_text(angle = 90),
         plot.title = element_text(hjust = 0.5),
         panel.grid.major.y = element_blank(),
         panel.grid.minor.y = element_blank(),
         panel.grid.major.x = element_line(),
         panel.grid.minor.x = element_blank(),
         legend.justification = "top")+
    labs(title = 'Findings' )+
    guides(fill = guide_legend(override.aes = aes(label = "")))
#grid.arrange(p,q, ncol = 2)
#ggplotly(grid.arrange(p,q, ncol =2))
ggplotly(p)
#ggplotly(q)
```

### subplot from plotly works for multiple plots

```{r subplot from plotly}
p <- ggplot(plotData )+
    geom_text(aes(x = SM, y = Value, label = paste(Dose, " mg/kg/day")),
               color = ifelse(plotData$NOAEL == TRUE, "#239B56", "black"),
               size = 6,
               #label.padding = unit(0.5, "lines"),
               fontface = "bold",
               position = ggstance::position_dodge2v(height = 1, preserve = "total",padding=2))+
  
    scale_x_log10(limits = c(min(plotData$SM/2), max(plotData$SM*2)),sec.axis = dup_axis())+
    facet_nested( Species+ Months ~ .)+
  
    labs(x = "Safety Margin", title = "Summary of Toxicology Studies")+
    theme_bw(base_size=12)+
    theme(axis.title.y = element_blank(),
          axis.ticks.y= element_blank(),
          axis.text.y = element_blank(),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          plot.title = element_text(hjust = 0.5),
          strip.text.y = element_text(size=11, color="black", face="plain"),
          strip.background = element_rect( fill = "white"))


q <- ggplot(findings_data_long)+
    geom_col(aes(x= Findings, y = Value, fill = Severity, group = Dose),
             position = position_stack(reverse = TRUE),
             color = 'transparent')+
    geom_text(aes(x = Findings, y = Value, label = Dose, group = Dose),
              size = 4,
              color = 'white',
              fontface = 'bold',
              position = position_stack(vjust = 0.5, reverse = TRUE))+
    scale_y_discrete(position = 'right')+
    scale_fill_manual(values = color_manual)+
    facet_grid(Study ~ ., scales = 'free')+

    theme_bw(base_size=12)+
    theme(axis.title.y = element_blank(),
           strip.text.y = element_blank(),
           axis.ticks.y = element_blank(),
           axis.text.y = element_blank(),
           axis.title.x = element_blank(),
           axis.text.x = element_text(angle = 90),
         plot.title = element_text(hjust = 0.5),
         panel.grid.major.y = element_blank(),
         panel.grid.minor.y = element_blank(),
         panel.grid.major.x = element_line(),
         panel.grid.minor.x = element_blank(),
         legend.justification = "top")+
    labs(title = 'Findings' )+
    guides(fill = guide_legend(override.aes = aes(label = "")))

p <- ggplotly(p, tooltip = "x")
q <- ggplotly(q, tooltip = "x")
subplot(p, q, nrows = 1)
```

```{r}
df <- data.frame(
  x = rep(c(2, 5, 7, 9, 12), 2),
  y = rep(c(1, 2), each = 5),
  z = factor(rep(1:5, each = 2)),
  w = rep(diff(c(0, 4, 6, 8, 10, 14)), 2)
)
ggplot(df, aes(x, y)) +
  geom_tile(aes(fill = z), colour = "grey50")
```

```{r}
ggplot(df, aes(xmin = x - w / 2, xmax = x + w / 2, ymin = y, ymax = y + 1)) +
  geom_rect(aes(fill = z), colour = "grey50")
```


```{r}
p <- ggplot(plotData )+ 
  # geom_rect(mapping = aes(xmin = SM-20, xmax = SM+20,ymin= SM -.5, ymax= SM+.5 ))+
    geom_text(aes(x= SM, y = Value, label = paste(Dose, " mg/kg/day")),
               color = ifelse(plotData$NOAEL == TRUE, "#239B56", "black"),
               #fill = ifelse(plotData$NOAEL == TRUE, "#239B56", "black"),
               #label.padding = unit(0.5, "lines"),
               fontface = "bold")+
               #position = ggstance::position_dodge2v(height = 1, preserve = "total",padding=2))+
  
    scale_x_log10(limits = c(min(plotData$SM/2), max(plotData$SM*2)),sec.axis = dup_axis())+
    facet_nested( Species+ Months ~ .)+
  
    labs(x = "Safety Margin", title = "Summary of Toxicology Studies")+
    theme_bw(base_size=12)+
    theme(axis.title.y = element_blank(),
          # axis.ticks.y= element_blank(),
          # axis.text.y = element_blank(),
          # panel.grid.major = element_blank(),
          # panel.grid.minor = element_blank(),
          # plot.title = element_text(hjust = 0.5),
          # strip.text.y = element_text(size=11, color="black", face="plain"),
          strip.background = element_rect( fill = "white"))
#ggplotly(p)
p
```

