---
title: "Findings in Bar Plot"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


### Import Library

```{r library, echo=TRUE, message=FALSE, warning=FALSE}
library(tidyverse)
library(ggstance)
library(ggrepel)
library(RColorBrewer)
library(patchwork)
library(ggh4x)
library(plotly)
library(scales)
#library(forcats)
```

### Create plotData dataframe for Safety Margin plot

```{r plotData dataframe}
Study <- rep(x = c("Rat-1-month", "Dog-1-month", "Dog-3-month", "Monkey-1-month"), times = 1, each = 3)
Dose <- c(1,33,100,1,3,10, 6, 30,78,5,50,90)
NOAEL <- c(TRUE, FALSE, FALSE, FALSE, TRUE, FALSE, FALSE,TRUE,FALSE,FALSE,TRUE,FALSE)
SM <- c(9.68, 319.35, 967.74, 33.33, 100.00, 333.333,200, 1000, 2600, 96,967.74,1741)
Dose_findings <- c("liver Necrosis [PR]", "liver Necrosis [PR]", "Mortality [NR]", "Emesis [Rev]",  "Emesis [Rev]", "Convulsion [NR]","Emesis [Rev]", "Carcinogenecity[NR]", "Emesis [Rev]",  "Necrosis[Rev]", "Necrosis[Rev]", "Carcinogenecity[NR]")

Severity_level <- c('Absent', 'Present', 'Minimal', 'Mild','Moderate','Marked', 'Severe')

Severity <- factor(c('Absent', 'Minimal', 'Mild','Moderate','Marked', 'Severe', 'Present',  'Minimal', 'Mild','Moderate','Marked', 'Severe'), levels = Severity_level)
Value <- c(rep(1, 12))

Value_order <- c(rep(c(1,2,3), 4))


plotData <- data.frame(Study, Dose, NOAEL, Dose_findings,Severity, SM, Value, Value_order)
print(plotData)
```

### Save species and duration (months) in separate variable

```{r make species a variable from study variable}
plotData <- separate(plotData, Study, into = c("Species","Months"), sep = "-", remove = FALSE,extra = 'merge' )
```

### Convert species as factor

```{r}
plotData$Species <- as.factor(plotData$Species)
```


### Create findings_data dataframe

```{r create findings_data}

# 4 study group
Study <- rep(x = c("Rat-1-month", "Dog-1-month",
                   "Dog-3-month", "Monkey-1-month"), times = 1, each = 3)
Dose <- c(1,33,100,1,3,10, 6, 30,78,5,50,90)
NOAEL <- c(TRUE, FALSE, FALSE, FALSE, TRUE, FALSE,
           FALSE,TRUE,FALSE,FALSE,TRUE,FALSE)
SM <- c(9.68, 319.35, 967.74, 33.33, 100.00, 333.333,
        200, 1000, 2600, 96,967.74,1741)

# add all the findings
Convulsion <- c("Absent","Absent","Absent","Absent","Absent","Mild",
                "Absent","Absent","Absent","Absent","Absent","Absent")

Liver_Necrosis_PR <- c("Absent", "Mild", "Severe", "Absent", "Absent", "Absent",
                       "Moderate","Absent","Absent","Absent","Absent","Absent")

Mortality_NR <- c("Absent","Absent","Marked","Absent","Absent",
                  "Mild","Absent","Absent","Mild","Absent","Absent","Absent")

Carcinogenecity <- c("Absent","Absent","Absent","Absent","Absent","Mild",
                     "Absent","Absent","Absent","Absent","Severe","Absent")

Emesis_Rev <- c("Absent","Absent","Absent","Mild","Marked","Severe",
                "Absent","Present","Absent","Absent","Absent","Absent")

Necrosis_Rev <- c("Absent","Absent","Absent","Absent","Absent","Mild",
                  "Absent","Absent","Absent","Minimal","Absent","Absent")

Value <- c(rep(1, 12)) # all the value 1

# Severity_level <- c('Absent', 'Present', 'Minimal', 'Mild','Moderate','Marked', 'Severe')

# dataframe

findings_data <- data.frame(Study, Dose, NOAEL, SM, Convulsion, Liver_Necrosis_PR, Mortality_NR, Carcinogenecity, Emesis_Rev, Necrosis_Rev, Value)

print(findings_data)
```

### convert wide to long data format

```{r wide data to long format data}
findings_data_long <- findings_data %>% gather(Findings,Severity, 5:10 )
print(head(findings_data_long))
print(dim(findings_data_long))
```

### Set Findings and Severity varialbe as factor

```{r Findings and Severity varialbe as factor}
findings_data_long$Findings <- as.factor(findings_data_long$Findings)
findings_data_long$Severity <- as.factor(findings_data_long$Severity)
# make severity ordered factor
findings_data_long$Severity <- factor(findings_data_long$Severity,  levels= c('Absent', 'Present','Minimal', 'Mild', 'Moderate', 'Marked', 'Severe'), ordered = TRUE)
```

### Create Species and Months variable from Study

```{r Make Species and Months variable from Study}
findings_data_long <- separate(findings_data_long, Study, into = c("Species","Months"), sep = "-", remove = FALSE,extra = 'merge' )
```

### Set Species and Months variable as factor

```{r Set Species and Months as factor}
findings_data_long$Species <- as.factor(findings_data_long$Species)
findings_data_long$Months <- as.factor(findings_data_long$Months)
```


### Color palettes

```{r make custom color palettes}
#color_man <- c('#ffffb2','#fed976','#feb24c','#fd8d3c','#fc4e2a','#e31a1c','#b10026')

color_manual <- c('transparent','black','#feb24c','#fd8d3c','#fc4e2a','#e31a1c','#b10026')

#color_man <- c('#b10026', '#e31a1c','#fc4e2a',  '#fd8d3c', '#feb24c', 'black', 'blue')
```


### safety margin plot in geom_tile with plotly

```{r safety margin and findings plot__ plotly}
color_NOAEL <- c("TRUE" = "#239B56", "FALSE" = "black")

marker <- list(
  color = "red",
  line = list(
    width = 20, 
    color = "black"
 )
)

p <- ggplot(plotData )+
  geom_tile(aes (x = SM, y = Value_order, fill = NOAEL), 
            color = "transparent", width = 0.35, height = 0.6)+
  geom_text(aes(x = SM, y = Value_order, label = paste(Dose, " mg/kg/day")),
            color = "white", fontface = "bold")+
  scale_x_log10(limits = c(min(plotData$SM/2), max(plotData$SM*2)),sec.axis = dup_axis())+
  scale_fill_manual(values = color_NOAEL)+
  facet_nested( Species+ Months ~ .)+
  labs( title = "Summary of Toxicology Studies")+
  theme_bw(base_size=12)+
  theme(axis.title.y = element_blank(),
          axis.ticks.y= element_blank(),
          axis.text.y = element_blank(),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          plot.title = element_text(hjust = 0.5),
          legend.position = "none",
          strip.text.y = element_text(size=11, color="black", face="plain"),
          strip.background = element_rect( fill = "white"))


q <- ggplot(findings_data_long)+
    geom_col(aes(x= Findings, y = Value, fill = Severity, group = Dose),
             position = position_stack(reverse = TRUE),
             color = 'transparent')+
    geom_text(aes(x = Findings, y = Value, label = Dose, group = Dose),
              size = 4,
              color = 'white',
              fontface = 'bold',
              position = position_stack(vjust = 0.5, reverse = TRUE))+
    scale_y_discrete(position = 'right')+
    scale_fill_manual(values = color_manual)+
    facet_grid(Study ~ ., scales = 'free')+
    theme_bw(base_size=12)+
    theme(axis.title.y = element_blank(),
           strip.text.y = element_blank(),
           axis.ticks.y = element_blank(),
           axis.text.y = element_blank(),
           axis.title.x = element_blank(),
           axis.text.x = element_text(angle = 90),
         plot.title = element_text(hjust = 0.5),
         panel.grid.major.y = element_blank(),
         panel.grid.minor.y = element_blank(),
         panel.grid.major.x = element_line(),
         panel.grid.minor.x = element_blank(),
         legend.justification = "top")+
    labs(title = 'Findings' )+
    guides(fill = guide_legend(override.aes = aes(label = "")))

#p + q + plot_layout(ncol=2,widths=c(3,1))

#ggplotly(p, tooltip = "x")

p <- ggplotly(p, tooltip = "x") %>% 
  style(showlegend = FALSE)
q <- ggplotly(q) %>% 
  style(hoverinfo = "none")
subplot(p, q, nrows = 1, widths = c(0.8, 0.2), titleX = TRUE, titleY = TRUE) %>% 
  layout(title= "Summary of Toxicology Studies",
         xaxis = list(title = "Safety Margin"), 
         xaxis2 = list(title = "Findings"))


```

```{r}
## create in plotly only

fig <- plot_ly(data = plotData, x = ~SM, y = ~Value_order) %>% 
  add_markers()

subplot(fig, nrow=4)




```

```{r}
fig <- plotData
fig <- fig %>% tidyr::gather(variable, value, -Study)
fig <- fig %>% transform(id = as.integer(factor(variable)))
fig <- fig %>% plot_ly(x = ~Study, y = ~value, color = ~variable, colors = "Dark2",
          yaxis = ~paste0("y", id))
fig <- fig %>% add_lines()
fig <- fig %>% subplot(nrows = 5, shareX = TRUE)

fig
```





```{r}
(p <- ggplotly(qplot(data = mtcars, wt, mpg, geom = c("point", "smooth"))))

# removes hoverinfo for the line/ribbon traces (use `plotly_json()` to verify!)

style(p, hoverinfo = "none", traces = c(1))
```






## Experimental Plots for Findings

### Value (all 1) on y (fixed value) and findings on x  

Dose shown inside bar does not match actual value.  


```{r Value (all 1) on y (fixed value) and findings on x bar_latest , echo=TRUE, fig.width=16, fig.height=12}

# p for safety plot 
p <- ggplot(plotData )+
    geom_label(aes(x = SM, y = Study, label = paste(Dose, " mg/kg/day")),
               color = 'white',
               fill = ifelse(plotData$NOAEL == TRUE, "#239B56", "black"),
               label.padding = unit(0.5, "lines"),
               fontface = "bold",
               position = ggstance::position_dodge2v(height = 3, preserve = "single"))+
  
    scale_x_log10(limits = c(min(plotData$SM/2), max(plotData$SM*2)),sec.axis = dup_axis())+
    facet_nested( Species+ Months ~ .)+
  
    labs(x = "Safety Margin", title = "Summary of Toxicology Studies")+
    theme_bw(base_size=12)+
    theme(axis.title.y = element_blank(),
          axis.ticks.y= element_blank(),
          axis.text.y = element_blank(),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          plot.title = element_text(hjust = 0.5),
          strip.text.y = element_text(size=11, color="black", face="bold"),
          strip.background = element_rect( fill = "white"))

# q is for findings plot
q <- ggplot(findings_data_long)+
    geom_col(aes(x= Findings, y =Value, fill = Severity), 
             position = 'stack', color= 'grey')+ 
    geom_text(aes(x= Findings, y= Value, label = Dose),
              size = 3, 
              color = 'white',
              position = position_stack(vjust = 0.5))+
    scale_y_continuous(position = 'right')+
    #scale_fill_brewer(palette="YlOrRd")+
    scale_fill_manual(values = color_manual)+
    facet_grid(Study ~ ., scales = 'free')+
  
    theme_bw(base_size=12)+
    theme(axis.title.y = element_blank(),
           strip.text.y = element_blank(),
           axis.ticks.y = element_blank(),
           #axis.text.y = element_blank(),
           axis.title.x = element_blank(), 
           axis.text.x = element_text(angle = 90),
         plot.title = element_text(hjust = 0.5),
         panel.grid.major.y = element_blank(),
         panel.grid.minor.y = element_blank(),
         panel.grid.major.x = element_line(),
         panel.grid.minor.x = element_blank())+
    labs(title = 'Dose shown in the box does not match actual value' )+
    guides(fill = guide_legend(override.aes = aes(label = ""))) #remove 'a' from legend
    
p + q + plot_layout(ncol=2,widths=c(3,1))

```


### add new variable value_order

```{r create value_order variable and set as factor}
findings_data_long["value_order"] <- rep(c(3,2,1),dim(findings_data_long)[1]/3) 
findings_data_long$value_order <- as.factor(findings_data_long$value_order)
print(head(findings_data_long))
```

### plot findings on x and value_order on y

Code changed in only findings plot(q)

```{r findings on x and value_order on y,  fig.width=16, fig.height=12}
# p for safety plot 
p <- ggplot(plotData )+
    geom_label(aes(x = SM, y = Study, label = paste(Dose, " mg/kg/day")),
               color = 'white',
               fill = ifelse(plotData$NOAEL == TRUE, "#239B56", "black"),
               label.padding = unit(0.5, "lines"),
               fontface = "bold",
               position = ggstance::position_dodge2v(height = 3, preserve = "single"))+
  
    scale_x_log10(limits = c(min(plotData$SM/2), max(plotData$SM*2)),sec.axis = dup_axis())+
    facet_nested( Species+ Months ~ .)+
  
    labs(x = "Safety Margin", title = "Summary of Toxicology Studies")+
    theme_bw(base_size=12)+
    theme(axis.title.y = element_blank(),
          axis.ticks.y= element_blank(),
          axis.text.y = element_blank(),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          plot.title = element_text(hjust = 0.5),
          strip.text.y = element_text(size=11, color="black", face="bold"),
          strip.background = element_rect( fill = "white"))

# q is for findings plot
q <- ggplot(findings_data_long)+
    geom_col(aes(x= Findings, y = value_order, fill = Severity), # y = value_order
             position = 'stack', color= 'grey')+ 
    geom_text(aes(x= Findings, y= value_order, label = Dose),
              size = 3, 
              color = 'white',
              position = position_stack(vjust = 0.5))+
    scale_y_discrete(position = 'right')+ # changed to discrete
    #scale_fill_brewer(palette="YlOrRd")+
    scale_fill_manual(values = color_manual)+
    facet_grid(Study ~ ., scales = 'free')+
  
    theme_bw(base_size=12)+
    theme(axis.title.y = element_blank(),
           strip.text.y = element_blank(),
           axis.ticks.y = element_blank(),
           #axis.text.y = element_blank(),
           axis.title.x = element_blank(), 
           axis.text.x = element_text(angle = 90),
         plot.title = element_text(hjust = 0.5),
         panel.grid.major.y = element_blank(),
         panel.grid.minor.y = element_blank(),
         panel.grid.major.x = element_line(),
         panel.grid.minor.x = element_blank())+
    labs(title = 'bar height is not equal: it is 3:2:1 ratio. \n\ but dose match' )+
    guides(fill = guide_legend(override.aes = aes(label = ""))) #remove 'a' from legend
    
p + q + plot_layout(ncol=2,widths=c(3,1))
```

### this plot just little cleaner than previous one

```{r absent now transparent_ findings on x and value_order on y ,  fig.width=16, fig.height=12}
# p for safety plot 
p <- ggplot(plotData )+
    geom_label(aes(x = SM, y = Study, label = paste(Dose, " mg/kg/day")),
               color = 'white',
               fill = ifelse(plotData$NOAEL == TRUE, "#239B56", "black"),
               label.padding = unit(0.5, "lines"),
               fontface = "bold",
               position = ggstance::position_dodge2v(height = 3, preserve = "single"))+
  
    scale_x_log10(limits = c(min(plotData$SM/2), max(plotData$SM*2)),sec.axis = dup_axis())+
    facet_nested( Species+ Months ~ .)+
  
    labs(x = "Safety Margin", title = "Summary of Toxicology Studies")+
    theme_bw(base_size=12)+
    theme(axis.title.y = element_blank(),
          axis.ticks.y= element_blank(),
          axis.text.y = element_blank(),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          plot.title = element_text(hjust = 0.5),
          strip.text.y = element_text(size=11, color="black", face="bold"),
          strip.background = element_rect( fill = "white"))

# q is for findings plot
q <- ggplot(findings_data_long)+
    geom_col(aes(x= Findings, y = value_order, fill = Severity), 
             position = 'stack', color= 'transparent')+  # changed grey to transparent
    geom_text(aes(x= Findings, y= value_order, label = Dose),
              size = 3, 
              color = 'white',
              position = position_stack(vjust = 0.5))+
    scale_y_discrete(position = 'right')+ 
    #scale_fill_brewer(palette="YlOrRd")+
    scale_fill_manual(values = color_manual)+
    facet_grid(Study ~ ., scales = 'free')+
  
    theme_bw(base_size=12)+
    theme(axis.title.y = element_blank(),
           strip.text.y = element_blank(),
           axis.ticks.y = element_blank(),
           axis.text.y = element_blank(),
           axis.title.x = element_blank(), 
           axis.text.x = element_text(angle = 90),
         plot.title = element_text(hjust = 0.5),
         panel.grid.major.y = element_blank(),
         panel.grid.minor.y = element_blank(),
         panel.grid.major.x = element_line(),
         panel.grid.minor.x = element_blank(),
         legend.justification = "top")+
    labs(title = 'Same as previous one: \n\ Absent now transparent and gone' )+
    guides(fill = guide_legend(override.aes = aes(label = ""))) #remove 'a' from legend
    
p + q + plot_layout(ncol=2,widths=c(3,1))
```



```{r more ticks in x axis ,  fig.width=16, fig.height=12}
# p for safety plot 


p <- ggplot(plotData )+
    geom_label(aes(x = SM, y = Value, label = paste(Dose, " mg/kg/day")),
               color = 'white',
               fill = ifelse(plotData$NOAEL == TRUE, "#239B56", "black"),
               label.padding = unit(0.5, "lines"),
               fontface = "bold",
               position = ggstance::position_dodge2v(height = 1, preserve = "total",padding=2))+
  
    # scale_x_log10(limits = c(min(plotData$SM/2), max(plotData$SM*2)),sec.axis = dup_axis(),
    #               breaks = trans_breaks('log10', function(x) 10^x), labels = label_number())+
  
  scale_x_log10(limits = c(min(plotData$SM/2), max(plotData$SM*2)),sec.axis = dup_axis(),
                  breaks = breaks_log(n= 10, base = 10), labels = label_number(accuracy = 1))+
  
    facet_nested( Species+ Months ~ .)+
  
    labs(x = "Safety Margin", title = "Summary of Toxicology Studies")+
    theme_bw(base_size=12)+
    theme(axis.title.y = element_blank(),
          axis.ticks.y= element_blank(),
          axis.text.y = element_blank(),
          #panel.grid.major = element_blank(),
          panel.grid.major.y = element_blank(),
          panel.grid.minor.y = element_blank(),
          panel.grid.minor = element_blank(),
          plot.title = element_text(hjust = 0.5),
          strip.text.y = element_text(size=11, color="black", face="plain"),
          strip.background = element_rect( fill = "white"))

# q is for findings plot

q <- ggplot(findings_data_long)+
    geom_col(aes(x= Findings, y = Value, fill = Severity, group = Dose),
             position = position_stack(reverse = TRUE),
             color = 'transparent')+
    geom_text(aes(x = Findings, y = Value, label = Dose, group = Dose),
              size = 4,
              color = 'white',
              fontface = 'bold',
              position = position_stack(vjust = 0.5, reverse = TRUE))+
    scale_y_discrete(position = 'right')+
    scale_fill_manual(values = color_manual)+
    facet_grid(Study ~ ., scales = 'free')+

    theme_bw(base_size=12)+
    theme(axis.title.y = element_blank(),
           strip.text.y = element_blank(),
           axis.ticks.y = element_blank(),
           axis.text.y = element_blank(),
           axis.title.x = element_blank(),
           axis.text.x = element_text(angle = 90),
         plot.title = element_text(hjust = 0.5),
         panel.grid.major.y = element_blank(),
         panel.grid.minor.y = element_blank(),
         panel.grid.major.x = element_line(),
         panel.grid.minor.x = element_blank(),
         legend.justification = "top")+
    labs(title = 'Findings' )+
    guides(fill = guide_legend(override.aes = aes(label = "")))
p + q + plot_layout(ncol=2,widths=c(3,1))
  

```

```{r plotly}

p <- ggplot(plotData )+
    geom_text(aes(x = SM, y = Value, label = paste(Dose, " mg/kg/day")),
               color = 'red',
               #fill = ifelse(plotData$NOAEL == TRUE, "#239B56", "black"),
               #label.padding = unit(0.5, "lines"),
               fontface = "bold",
               position = ggstance::position_dodge2v(height = 1, preserve = "total",padding=2))+
  
    scale_x_log10(limits = c(min(plotData$SM/2), max(plotData$SM*2)),sec.axis = dup_axis())+
    facet_nested( Species+ Months ~ .)+
  
    labs(x = "Safety Margin", title = "Summary of Toxicology Studies")+
    theme_bw(base_size=12)+
    theme(axis.title.y = element_blank(),
          axis.ticks.y= element_blank(),
          axis.text.y = element_blank(),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          plot.title = element_text(hjust = 0.5),
          strip.text.y = element_text(size=11, color="black", face="plain"),
          strip.background = element_rect( fill = "white"))
ggplotly(p)
# q is for findings plot
# q <- ggplot(findings_data_long)+
#     geom_col(aes(x= Findings, y = Value, fill = Severity, group = Dose), 
#              position = position_stack(reverse = TRUE), 
#              color = 'transparent')+  
#     geom_text(aes(x = Findings, y = Value, label = Dose, group = Dose),
#               size = 4,
#               color = 'white',
#               fontface = 'bold',
#               position = position_stack(vjust = 0.5, reverse = TRUE))+
#     scale_y_discrete(position = 'right')+ 
#     scale_fill_manual(values = color_manual)+
#     facet_grid(Study ~ ., scales = 'free')+
#   
#     theme_bw(base_size=12)+
#     theme(axis.title.y = element_blank(),
#            strip.text.y = element_blank(),
#            axis.ticks.y = element_blank(),
#            axis.text.y = element_blank(),
#            axis.title.x = element_blank(), 
#            axis.text.x = element_text(angle = 90),
#          plot.title = element_text(hjust = 0.5),
#          panel.grid.major.y = element_blank(),
#          panel.grid.minor.y = element_blank(),
#          panel.grid.major.x = element_line(),
#          panel.grid.minor.x = element_blank(),
#          legend.justification = "top")+
#     labs(title = 'Findings' )+
#     guides(fill = guide_legend(override.aes = aes(label = ""))) #remove 'a' from legend
#     
# p + q + plot_layout(ncol=2,widths=c(3,1))
```



```{r for safety margin plot}
findings_data_long_p <- findings_data_long %>%
  select(- c (Findings, Severity, value_order)) %>% 
  group_by(Study, Dose, SM) %>% 
  unique()
```

```{r findings long to  wide}
finding_wide <- findings_data_long %>% 
  pivot_wider(names_from = Findings, values_from = Severity)
finding_wide

```



```{r from_Dr. Snyder _from same dataset ,  fig.width=16, fig.height=12}
# p for safety plot 
p <- ggplot(findings_data_long_p)+
    geom_label(aes(x = SM, y = Value, label = paste(Dose, " mg/kg/day")),
               color = 'white',
               fill = ifelse(findings_data_long_p$NOAEL == TRUE, "#239B56", "black"),
               label.padding = unit(0.5, "lines"),
               fontface = "bold",
               position = ggstance::position_dodge2v(height = 1, preserve = "total",padding=2))+
  
    scale_x_log10(limits = c(min(findings_data_long$SM/2),
                             max(findings_data_long$SM*2)), sec.axis = dup_axis())+
    facet_nested( Species+ Months ~ .)+
  
    labs(x = "Safety Margin", title = "Summary of Toxicology Studies")+
    theme_bw(base_size=12)+
    theme(axis.title.y = element_blank(),
          axis.ticks.y= element_blank(),
          axis.text.y = element_blank(),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          plot.title = element_text(hjust = 0.5),
          strip.text.y = element_text(size=11, color="black", face="plain"),
          strip.background = element_rect( fill = "white"))

# q is for findings plot
q <- ggplot(findings_data_long)+
    geom_col(aes(x= Findings, y = Value, fill = Severity, group = Dose), 
             position = position_stack(reverse = TRUE), 
             color = 'transparent')+  
    geom_text(aes(x = Findings, y = Value, label = Dose, group = Dose),
              size = 4,
              color = 'white',
              fontface = 'bold',
              position = position_stack(vjust = 0.5, reverse = TRUE))+
    scale_y_discrete(position = 'right')+ 
    scale_fill_manual(values = color_manual)+
    facet_grid(Study ~ ., scales = 'free')+
  
    theme_bw(base_size=12)+
    theme(axis.title.y = element_blank(),
           #strip.text.y = element_blank(),
           axis.ticks.y = element_blank(),
           axis.text.y = element_blank(),
           axis.title.x = element_blank(), 
           axis.text.x = element_text(angle = 90),
         plot.title = element_text(hjust = 0.5),
         panel.grid.major.y = element_blank(),
         panel.grid.minor.y = element_blank(),
         panel.grid.major.x = element_line(),
         panel.grid.minor.x = element_blank(),
         legend.justification = "top")+
    labs(title = 'Findings' )+
    guides(fill = guide_legend(override.aes = aes(label = ""))) #remove 'a' from legend
    
p + q + plot_layout(ncol=2,widths=c(3,1))

```


```{r from_Dr. Snyder absent now transparent_ findings on x and value_order on y (NOAEL) ,  fig.width=16, fig.height=12}
# p for safety plot 
p <- ggplot(plotData )+
    geom_label(aes(x = SM, y = Value, label = paste(Dose, " mg/kg/day")),
               color = 'white',
               fill = ifelse(plotData$NOAEL == TRUE, "#239B56", "black"),
               label.padding = unit(0.5, "lines"),
               fontface = "bold",
               position = ggstance::position_dodge2v(height = 1, preserve = "total",padding=2))+
  
    scale_x_log10(limits = c(min(plotData$SM/2), max(plotData$SM*2)),sec.axis = dup_axis())+
    facet_nested( Species+ Months ~ .)+
  
    labs(x = "Safety Margin", title = "Summary of Toxicology Studies")+
    theme_bw(base_size=12)+
    theme(axis.title.y = element_blank(),
          axis.ticks.y= element_blank(),
          axis.text.y = element_blank(),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          plot.title = element_text(hjust = 0.5),
          strip.text.y = element_text(size=11, color="black", face="plain"),
          strip.background = element_rect( fill = "white"))

# q is for findings plot
q <- ggplot(findings_data_long)+
    geom_col(aes(x= Findings, y = Value, fill = Severity, group = Dose), 
             position = position_stack(reverse = T), 
             color = "transparent")+  
    geom_text(aes(x = Findings, y = Value, label = Dose,group = Dose),
              size = 4,
              color = 'white',
              fontface = 'bold',
              position = position_stack(vjust = 0.5,reverse=T))+
    scale_y_discrete(position = 'right')+ 
    #scale_fill_brewer(palette="YlOrRd")+
    scale_fill_manual(values = color_manual)+
    facet_grid(Study ~ ., scales = 'free')+
  
    theme_bw(base_size=12)+
    theme(axis.title.y = element_blank(),
           strip.text.y = element_blank(),
           axis.ticks.y = element_blank(),
           axis.text.y = element_blank(),
           axis.title.x = element_blank(), 
           axis.text.x = element_text(angle = 90),
         plot.title = element_text(hjust = 0.5),
         panel.grid.major.y = element_blank(),
         panel.grid.minor.y = element_blank(),
         panel.grid.major.x = element_line(),
         panel.grid.minor.x = element_blank())+
    labs(title = 'From Dr. Snyder' )+
    guides(fill = guide_legend(override.aes = aes(label = ""))) #remove 'a' from legend
  
p + q + plot_layout(ncol=2,widths=c(3,1))

```


### with geom_label_repel function 

```{r with geom_label_repel function, fig.width=16, fig.height=12}
# p for safety plot 
p <- ggplot(plotData )+
    geom_label(aes(x = SM, y = Study, label = paste(Dose, " mg/kg/day")),
               color = 'white',
               fill = ifelse(plotData$NOAEL == TRUE, "#239B56", "black"),
               label.padding = unit(0.5, "lines"),
               fontface = "bold",
               position = ggstance::position_dodge2v(height = 3, preserve = "single"))+
  
    scale_x_log10(limits = c(min(plotData$SM/2), max(plotData$SM*2)),sec.axis = dup_axis())+
    facet_nested( Species+ Months ~ .)+
  
    labs(x = "Safety Margin", title = "Summary of Toxicology Studies")+
    theme_bw(base_size=12)+
    theme(axis.title.y = element_blank(),
          axis.ticks.y= element_blank(),
          axis.text.y = element_blank(),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          plot.title = element_text(hjust = 0.5),
          strip.text.y = element_text(size=11, color="black", face="bold"),
          strip.background = element_rect( fill = "white"))

# q is for findings plot
q <- ggplot(findings_data_long)+
    geom_label_repel(aes(y= Dose , x = Findings, label = Dose, fill = Severity),
                     color = ifelse(findings_data_long$Severity == "Absent", "transparent", "white"), 
                     fontface = 'bold',
                     label.padding = unit(.5, 'lines'),
                     direction = 'y',
                     segment.color = NA)+
    scale_y_continuous(position = 'right')+ 
    #scale_fill_brewer(palette="YlOrRd")+
    scale_fill_manual(values = color_manual)+
    facet_grid(Study ~ ., scales = 'free')+
  
    theme_bw(base_size=12)+
    theme(axis.title.y = element_blank(),
           strip.text.y = element_blank(),
           axis.ticks.y = element_blank(),
           #axis.text.y = element_blank(),
           axis.title.x = element_blank(), 
           axis.text.x = element_text(angle = 90),
         plot.title = element_text(hjust = 0.5),
         panel.grid.major.y = element_blank(),
         panel.grid.minor.y = element_blank(),
         panel.grid.major.x = element_line(),
         panel.grid.minor.x = element_blank())+
    labs(title = 'with geom_label_repel function' )+
    guides(fill = guide_legend(override.aes = aes(label = ""))) #remove 'a' from legend
    
p + q + plot_layout(ncol=2,widths=c(3,1))

```

### with geom_point and geom_text function

box (shape) size can be changed in geom_point

```{r with geom_point and geom_text}

# p for safety plot 
# p <- ggplot(plotData )+
#     geom_label(aes(x = SM, y = Study, label = paste(Dose, " mg/kg/day")),
#                color = 'white',
#                fill = ifelse(plotData$NOAEL == TRUE, "#239B56", "black"),
#                label.padding = unit(0.5, "lines"),
#                fontface = "bold",
#                position = ggstance::position_dodge2v(height = 3, preserve = "single"))+
#   
#     scale_x_log10(limits = c(min(plotData$SM/2), max(plotData$SM*2)),sec.axis = dup_axis())+
#     facet_nested( Species+ Months ~ .)+
#   
#     labs(x = "Safety Margin", title = "Summary of Toxicology Studies")+
#     theme_bw(base_size=12)+
#     theme(axis.title.y = element_blank(),
#           axis.ticks.y= element_blank(),
#           axis.text.y = element_blank(),
#           panel.grid.major = element_blank(),
#           panel.grid.minor = element_blank(),
#           plot.title = element_text(hjust = 0.5),
#           strip.text.y = element_text(size=11, color="black", face="bold"),
#           strip.background = element_rect( fill = "white"))


# q is for findings plot
q <- ggplot(findings_data_long)+
    geom_point(aes(y = Dose, x= Findings, fill = Severity), 
               size = 12,
               shape = 22,
               color = "transparent")+
    geom_text(aes(y= Dose, x = Findings, label = Dose),
              color = "white",
              position = position_dodge2v(height = 0.5, preserve = 'single'))+
    scale_y_continuous(position = 'right')+ 
    #scale_fill_brewer(palette="YlOrRd")+
    scale_fill_manual(values = color_manual)+
    facet_grid(Study ~ ., scales = 'free')+
  
    theme_bw(base_size=12)+
    theme(axis.title.y = element_blank(),
           strip.text.y = element_blank(),
           axis.ticks.y = element_blank(),
           #axis.text.y = element_blank(),
           axis.title.x = element_blank(), 
           axis.text.x = element_text(angle = 90),
         plot.title = element_text(hjust = 0.5),
         panel.grid.major.y = element_blank(),
         panel.grid.minor.y = element_blank(),
         panel.grid.major.x = element_line(),
         panel.grid.minor.x = element_blank())+
    labs(title = 'with geom_point and geom_text function' )+
    guides(fill = guide_legend(override.aes = aes(label = ""))) #remove 'a' from legend
    
# p + q + plot_layout(ncol=2,widths=c(3,1))
ggplotly(q)

```


```{r}
p <- ggplot(plotData )+
    geom_label(aes(x = SM, y = Study, label = paste(Dose, " mg/kg/day")),
               color = 'white',
               fill = ifelse(plotData$NOAEL == TRUE, "#239B56", "black"),
               label.padding = unit(0.5, "lines"),
               fontface = "bold",
               position = ggstance::position_dodge2v(height = 3, preserve = "single"))+

    scale_x_log10(limits = c(min(plotData$SM/2), max(plotData$SM*2)),sec.axis = dup_axis())+
    facet_nested( Species+ Months ~ .)+

    labs(x = "Safety Margin", title = "Summary of Toxicology Studies")+
    theme_bw(base_size=12)+
    theme(axis.title.y = element_blank(),
          axis.ticks.y= element_blank(),
          axis.text.y = element_blank(),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          plot.title = element_text(hjust = 0.5),
          strip.text.y = element_text(size=11, color="black", face="bold"),
          strip.background = element_rect( fill = "white"))
ggplotly(p)
```



```{r}
fig <- economics
fig <- fig %>% tidyr::gather(variable, value, -date)
fig <- fig %>% transform(id = as.integer(factor(variable)))
fig <- fig %>% plot_ly(x = ~date, y = ~value, color = ~variable, colors = "Dark2",
          yaxis = ~paste0("y", id))
fig <- fig %>% add_lines()
fig <- fig %>% subplot(nrows = 5, shareX = TRUE)

fig
```

